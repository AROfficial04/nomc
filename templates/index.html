<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nomc Website</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        *{
            font-family: Verdana, Geneva, Tahoma, sans-serif;
        }
        body {
            font-family: Arial, sans-serif;
            height: 100vh;
            /* height: 100%; */


            background-image: url("{{ url_for('static', filename='bg5.jpg') }}");
            background-size: cover;
            background-position: center;
        }

        .container {
            width: 80%;
            margin: auto;
            padding: 20px;
            display: flex;
            justify-content: space-evenly;
        }

        h1 {
            text-align: center;
        }

        .file-input,
        .column-select,
        .process-section {
            margin: 20px 0;
        }

        button {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 16px;
        }

        .dropdown {
            margin: 10px 0;
        }

        /* Loader Styles */
        #loader {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            color: #000;
            z-index: 1000;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table,
        th,
        td {
            border: 1px solid black;
        }

        th,
        td {
            padding: 10px;
            text-align: left;
        }

        /* Dropdown container */
        .dropdown {
            position: relative;
        }

        .dropbtn {
            cursor: pointer;
        }

        /* Dropdown menu styles */
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #f4f4f4;
            border: 1px solid #ccc;
            padding: 10px;
            z-index: 1000;
            list-style: none;
            /* width: 15%; */
            font-weight: 600;
        }

        .dropdown:hover .dropdown-menu {
            display: block;
        }

        .dropdown-menu ul {
            list-style: none;
            margin: 5px 0;
            padding: 0;
        }

        .dropdown-menu ul li {
            margin: 5px 0;
        }

        .boxes {
            /* height: 15rem; */
            /* border: 2px solid blue; */
            backdrop-filter:blur("10%");
            background: #ffffff8d;
            border-radius: 2rem;
            padding: 0.5rem 2rem 0rem 1rem;
            align-items: center;
            
            max-width: 50%;
            /* width: 40rem; */
            box-shadow: rgba(50, 50, 93, 0.25) 0px 50px 100px -20px, rgba(0, 0, 0, 0.3) 0px 30px 60px -30px, rgba(10, 37, 64, 0.35) 0px -2px 6px 0px inset;
        }

        label {
            margin: 2rem 0;
        }

        input {
            margin: 1rem 0;
        }

        .boxes h3 {
            color: orange;
            font-size: 22px;
        }

        nav {
            /* Apply a background color with transparency */
            background: rgba(255, 255, 255, 0.236);
            /* Slightly transparent white */

            /* Apply the glass effect with backdrop blur */
            backdrop-filter: blur(15%);
            /* This is the key for the frosted glass effect */

            /* Border radius for rounded corners */
            border-radius: 25rem;

            /* Apply shadows to create depth */
            box-shadow: rgba(50, 50, 93, 0.25) 0px 50px 100px -20px,
                rgba(0, 0, 0, 0.3) 0px 30px 60px -30px,
                rgba(10, 37, 64, 0.35) 0px -2px 6px 0px inset;

            /* Padding and margin for layout */
            padding: 0rem 2rem;
            margin: 0 3rem;

            /* Center the contents of the nav */
            display: flex;
            justify-content: space-between;
            align-items: center;

            /* Optional: make sure text is legible on the transparent background */
            color: #ffffff;
            border: none;
            /* Optional: Removes any border */
        }


        nav ul li a {

            text-decoration: none;
            color: rgb(0, 140, 255);
            font-size: 18px;
            /* font-weight:600; */

        }

        nav ul li a:hover {

            text-decoration: none;
            color: rgb(0, 57, 103);
            font-size: 1.2rem;
            font-weight: 600;

        }

        li {
            list-style: none;
        }

        select {
            height: 2rem;
            width: 10rem;
        }

        .process-section button {
            height: 3rem;
            width: 12rem;
            box-shadow: rgba(50, 50, 93, 0.25) 0px 25px 50px -10px, rgba(78, 78, 78, 0.3) 0px 30px 60px -30px, rgba(10, 37, 64, 0.35) 0px -2px 6px 0px inset;
            color: greenyellow;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 1rem;
            border: none;
            background: #ffffff
        }

        .process-section button:hover {
            height: 3rem;
            width: 12rem;
            box-shadow: rgba(0, 255, 102, 0.25) 0px 25px 50px -10px, rgba(78, 78, 78, 0.3) 0px 30px 60px -30px, rgba(10, 37, 64, 0.35) 0px -2px 6px 0px inset;
            color: rgb(255, 255, 255);
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 1rem;
            border: none;
            background: #86ec00
        }

        .boxes:hover {
            background-color: #ffffff3d;
        }
    </style>
</head>

<body>
    <header>
        <div style="display: flex;margin: 0 3rem;justify-content: space-between;" class="logo-name">
            <img height="50" src="{{ url_for('static', filename='logonew.png') }}" alt="">
            <h2 style="margin-left: 1rem;color: orangered;">Network Operating and Monitoring Centre <span style="color: rgb(0, 106, 255);">(NOMC)</span></h2>
            <img height="50" src="{{ url_for('static', filename='cspdcl.jpg') }}" alt="">
        </div>
        <nav>
            <ul>
                <li class="dropdown">
                    <a href="#" class="dropbtn">Dashboard</a>
                    <ul style="padding: 1rem;border-radius: 1rem;" class="dropdown-menu">
                        <div style="color: rgb(55, 55, 55);margin: 15px;" id="links"></div>
                    </ul>
                </li>
            </ul>
        </nav>
    </header>


    <div class="container">
        <!-- <h1>Nomc Website</h1> -->
        <div class="boxes">
            <div class="file-input">
                <h3>Upload Files</h3>
                <label>File 1 (WFM) :</label>
                <input type="file" id="file1" onchange="fetchColumns('file1')"><br><br>
                <label>File 2 (HES) :</label>
                <input type="file" id="file2" onchange="fetchColumns('file2')"><br><br>
            </div>
            <div class="column-select">
                <h3>Select Columns</h3>
                <label>WFM Column :</label>
                <select id="wfmColumn" class="dropdown">
                    <option value="" disabled selected>Select column</option>
                </select><br><br>
                <label>HES Column :</label>
                <select id="hesColumn" class="dropdown">
                    <option value="" disabled selected>Select column</option>
                </select><br><br>
                <label>Non-Comm Column :</label>
                <select id="nonCommColumn" class="dropdown">
                    <option value="" disabled selected>Select column</option>
                </select><br><br>
            </div>
        </div>
        <div style="display: inline;justify-content: center;width: 60%;height:100%;" class="">
            <div style="max-height: 100%;max-width: 100%;" class="boxes">
                <div id="summarySection" style="display: none; margin-top: 20px;">
                    <h3 style="text-align: center; margin-bottom: 20px;">Summary</h3>
                    <div id="summaryCards" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">
                        <!-- Cards will be dynamically inserted here -->
                    </div>
                </div>
                
            </div>
           <br>
            <div class="process-section">
                <button id="processButton">Process Data</button>
            </div>
            <!-- <div id="links"></div> -->
            <div id="preview" style="display: none;">
                <!-- <h3>Preview Processed Data</h3> -->
                <!-- <table id="dataTable"></table> -->
                <button id="downloadButton" style="display: none;">Download Processed Data</button>
            </div>
          
        </div>
       

        <!-- Loader -->
        <div id="loader"><img height="70" src="{{ url_for('static', filename='1495.png') }}" alt="Logo">
        </div>
    </div>

    

    <script>
        function fetchColumns(fileInputId) {
            // Show loader when processing
            document.getElementById('loader').style.display = 'block';

            const fileInput = document.getElementById(fileInputId);
            const formData = new FormData();
            formData.append("file", fileInput.files[0]);

            $.ajax({
                url: "/get_columns",
                type: "POST",
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    // Hide loader once columns are fetched
                    document.getElementById('loader').style.display = 'none';

                    if (fileInputId === "file1") {
                        populateDropdown("#wfmColumn", response.columns);
                    } else if (fileInputId === "file2") {
                        populateDropdown("#nonCommColumn", response.columns);
                        populateDropdown("#hesColumn", response.columns);
                    }
                },
                error: function (xhr) {
                    // Hide loader if error occurs
                    document.getElementById('loader').style.display = 'none';
                    alert("Error: " + xhr.responseJSON.error);
                }
            });
        }

        function populateDropdown(dropdownId, columns) {
            const dropdown = $(dropdownId);
            dropdown.empty();
            dropdown.append('<option value="" disabled selected>Select column</option>');
            columns.forEach(column => {
                dropdown.append(`<option value="${column}">${column}</option>`);
            });
        }

        $("#processButton").click(function () {
            // Show loader during data processing
            document.getElementById('loader').style.display = 'block';

            let formData = new FormData();
            formData.append("file1", $("#file1")[0].files[0]);
            formData.append("file2", $("#file2")[0].files[0]);
            formData.append("wfmColumn", $("#wfmColumn").val());
            formData.append("hesColumn", $("#hesColumn").val());
            formData.append("nonCommColumn", $("#nonCommColumn").val());

            $.ajax({
                url: "/process_data",
                type: "POST",
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    // Hide loader once data is processed
                    document.getElementById('loader').style.display = 'none';

                    // Display the processed data preview
                    // showPreview(response);

                    // Display download links after previewing
                    $("#links").html(` 
                        
                        <a href="${response.nonCommFile}" download>Non-Comm Data</a><br>
                        <a href="${response.neverCommFile}" download> Never-Comm Data</a><br>
                        <a href="${response.unmappedFile}" download> Unmapped Data</a><br>
                    `);
                },
                error: function (xhr) {
                    // Hide loader on error
                    document.getElementById('loader').style.display = 'none';
                    alert("Error: " + xhr.responseJSON.error);
                }
            });
        });

        // function showPreview(response) {
        //     // Show the preview section
        //     document.getElementById('preview').style.display = 'block';

        //     // Assuming the data is in a tabular format (e.g., JSON array of rows)
        //     const data = response.previewData;
        //     const table = $("#dataTable");

        //     // Clear previous data in the table
        //     table.empty();

        //     // Create table headers
        //     if (data && data.length > 0) {
        //         const headers = Object.keys(data[0]);
        //         const headerRow = $("<tr>");
        //         headers.forEach(header => {
        //             headerRow.append(`<th>${header}</th>`);
        //         });
        //         table.append(headerRow);

        //         // Add table rows
        //         data.forEach(row => {
        //             const rowElement = $("<tr>");
        //             headers.forEach(header => {
        //                 rowElement.append(`<td>${row[header]}</td>`);
        //             });
        //             table.append(rowElement);
        //         });

        //         // Show the download button after preview
        //         $("#downloadButton").show();
        //     } else {
        //         table.append("<tr><td colspan='100%'>No data to display.</td></tr>");
        //     }
        // }
        function updateSummary(summary) {
    const summarySection = document.getElementById("summarySection");
    const summaryCards = document.getElementById("summaryCards");

    // Clear previous summary content
    summaryCards.innerHTML = "";

    // Main summary categories
    const mainCategories = [
        { title: "WFM Total Entries", count: summary["WFM Total Entries"] },
        { title: "HES Total Entries", count: summary["HES Total Entries"] },
        { title: "Non-Comm Count", count: summary["Non-Comm Count"] },
        { title: "Never-Comm Count", count: summary["Never-Comm Count"] },
        { title: "Unmapped Count", count: summary["Unmapped Count"] },
        { title: "Matched Entries", count: summary["Matched Entries"] },
    ];
    console.log(mainCategories)

    mainCategories.forEach((category) => {
        const card = document.createElement("div");
        card.style.cssText = `
            flex: 1 1 calc(300px - 20px);
            background: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            text-align: center;
        `;
        card.innerHTML = `
            <h4 style="margin-bottom: 10px; color: #333;">${category.title}</h4>
            <p style="font-size: 20px; font-weight: bold; color: #007bff;">${category.count}</p>
        `;
        summaryCards.appendChild(card);
    });

    // Add detailed analysis
    const detailedAnalysis = summary["Detailed Analysis"];
    Object.keys(detailedAnalysis).forEach((file) => {
        const fileAnalysis = detailedAnalysis[file];

        Object.keys(fileAnalysis).forEach((column) => {
            const columnData = fileAnalysis[column];

            const card = document.createElement("div");
            card.style.cssText = `
                flex: 1 1 calc(300px - 20px);
                background: #f9f9f9;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                padding: 20px;
            `;
            card.innerHTML = `
                <h4 style="margin-bottom: 10px; color: #333;">${file} - ${column}</h4>
                <p style="margin-bottom: 10px; color: #555;">Unique Values: ${columnData.unique_count}</p>
                <p style="color: #555;">Frequencies:</p>
                <ul style="list-style: none; padding: 0; margin: 0;">
                    ${Object.entries(columnData.frequencies)
                        .map(
                            ([value, count]) =>
                                `<li style="margin-bottom: 5px; color: #666;">
                                    <strong>${value}:</strong> ${count}
                                </li>`
                        )
                        .join("")}
                </ul>
            `;
            summaryCards.appendChild(card);
        });
    });

    // Show the updated summary section
    summarySection.style.display = "block";
}


        $("#processButton").click(function () {
            // Show loader during data processing
            document.getElementById("loader").style.display = "block";

            let formData = new FormData();
            formData.append("file1", $("#file1")[0].files[0]);
            formData.append("file2", $("#file2")[0].files[0]);
            formData.append("wfmColumn", $("#wfmColumn").val());
            formData.append("hesColumn", $("#hesColumn").val());
            formData.append("nonCommColumn", $("#nonCommColumn").val());

            $.ajax({
                url: "/process_data",
                type: "POST",
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    // Hide loader once data is processed
                    document.getElementById("loader").style.display = "none";

                    // Display the processed data preview (optional)
                    // showPreview(response.previewData);

                    // Update the summary section with response data
                    updateSummary(response.summary);
                },
                error: function (xhr) {
                    // Hide loader and show an error message
                    document.getElementById("loader").style.display = "none";
                    alert("An error occurred while processing the files. Please try again.");
                },
            });
        });
    </script>
</body>

</html>
