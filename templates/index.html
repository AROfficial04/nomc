<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nomc Website</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: whitesmoke;
            height: 100vh;
            /* height: 100%; */
        
        }
        
        .container {
            width: 80%;
            margin: auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
        }
        .file-input, .column-select, .process-section {
            margin: 20px 0;
        }
        button {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 16px;
        }
        .dropdown {
            margin: 10px 0;
        }
        /* Loader Styles */
        #loader {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            color: #000;
            z-index: 1000;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        /* Dropdown container */
.dropdown {
    position: relative;
}

.dropbtn {
    cursor: pointer;
}

/* Dropdown menu styles */
.dropdown-menu {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    background: #f4f4f4;
    border: 1px solid #ccc;
    padding: 10px;
    z-index: 1000;
    list-style: none;
    /* width: 15%; */
    font-weight: 600;
}

.dropdown:hover .dropdown-menu {
    display: block;
}

.dropdown-menu ul {
    list-style: none;
    margin: 5px 0;
    padding: 0;
}

.dropdown-menu ul li {
    margin: 5px 0;
}
.boxes{
    /* height: 15rem; */
    /* border: 2px solid blue; */
    border-radius: 1rem;
    padding: 0 2rem 2rem 1rem;
    align-items: center;
    margin: 2rem;
    width: 40rem;
    box-shadow: rgba(50, 50, 93, 0.25) 0px 50px 100px -20px, rgba(0, 0, 0, 0.3) 0px 30px 60px -30px, rgba(10, 37, 64, 0.35) 0px -2px 6px 0px inset;
}
label{
    margin: 2rem 0;
}
input{
    margin: 1rem 0;
}
.boxes h3{
    color: orange;
}
nav{
    box-shadow: rgba(50, 50, 93, 0.25) 0px 50px 100px -20px, rgba(0, 0, 0, 0.3) 0px 30px 60px -30px, rgba(10, 37, 64, 0.35) 0px -2px 6px 0px inset;
    border-radius: 1.5rem;
    padding: 0.1rem 2rem;
    margin: 0 3rem;
    background: #cccccc40;
    border-radius: 1rem;
}
nav ul li a{
    
    text-decoration: none;
    color: rgb(0, 140, 255);
    font-size: 1.2rem;
    /* font-weight:600; */
    
}
li{
    list-style: none;
}
select{
    height: 2rem;width: 10rem;
}
.process-section button{
    height: 3rem;
    width: 12rem;
    box-shadow: rgba(50, 50, 93, 0.25) 0px 25px 50px -10px, rgba(78, 78, 78, 0.3) 0px 30px 60px -30px, rgba(10, 37, 64, 0.35) 0px -2px 6px 0px inset;
    color: greenyellow;
    font-size: 1.2rem;
    font-weight: bold;
    border-radius: 1rem;
    border: none;
    background: #ffffff

}
.process-section button:hover{
    height: 3rem;
    width: 12rem;
    box-shadow: rgba(0, 255, 102, 0.25) 0px 25px 50px -10px, rgba(78, 78, 78, 0.3) 0px 30px 60px -30px, rgba(10, 37, 64, 0.35) 0px -2px 6px 0px inset;
    color: rgb(255, 255, 255);
    font-size: 1.2rem;
    font-weight: bold;
    border-radius: 1rem;
    border: none;
    background: #86ec00

}
.boxes:hover{
    background-color: #cccccc24;
}

    </style>
</head>
<body>
    <header>
        <div style="display: flex;margin: 0 3rem;" class="logo-name">
            <img height="50" src="{{ url_for('static', filename='logonew.png') }}" alt="">
            <h2 style="margin-left: 1rem;">Network Operating and Monitoring Centre</h2>
        </div>
        <nav>
            <ul>
                <li class="dropdown">
                    <a href="#" class="dropbtn">Dashboard</a>
                    <ul style="padding: 1rem;border-radius: 1rem;" class="dropdown-menu">
                        <div style="color: rgb(55, 55, 55);margin: 15px;" id="links"></div>
                    </ul>
                </li>
            </ul>
        </nav>
    </header>
   
    
    <div class="container">
        <!-- <h1>Nomc Website</h1> -->
         <div style="display: flex;" class="contain">
        <div class="file-input boxes">
            <h3>Upload Files</h3>
            <label>File 1 (WFM) :</label>
            <input type="file" id="file1" onchange="fetchColumns('file1')"><br><br>
            <label>File 2 (HES) :</label>
            <input type="file" id="file2" onchange="fetchColumns('file2')"><br><br>
        </div>
        <div class="column-select boxes">
            <h3>Select Columns</h3>
            <label>WFM Column :</label>
            <select id="wfmColumn" class="dropdown">
                <option value="" disabled selected>Select column</option>
            </select><br><br>
            <label>HES Column :</label>
            <select id="hesColumn" class="dropdown">
                <option value="" disabled selected>Select column</option>
            </select><br><br>
            <label>Non-Comm Column :</label>
            <select id="nonCommColumn" class="dropdown">
                <option value="" disabled selected>Select column</option>
            </select><br><br>
        </div>
    </div>
        <div class="process-section">
            <button id="processButton">Process Data</button>
        </div>
        <!-- <div id="links"></div> -->
        <div id="preview" style="display: none;">
            <h3>Preview Processed Data</h3>
            <table id="dataTable"></table>
            <button id="downloadButton" style="display: none;">Download Processed Data</button>
        </div>

        <!-- Loader -->
        <div id="loader"><img  src="{{ url_for('static', filename='832.svg') }}" alt="Logo">
        </div>
    </div>

    <div id="summarySection" style="display: none; margin-top: 20px;">
        <h3>Summary</h3>
        <table id="summaryTable" style="width: 100%; text-align: left;">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Count</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        function fetchColumns(fileInputId) {
            // Show loader when processing
            document.getElementById('loader').style.display = 'block';

            const fileInput = document.getElementById(fileInputId);
            const formData = new FormData();
            formData.append("file", fileInput.files[0]);

            $.ajax({
                url: "/get_columns",
                type: "POST",
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    // Hide loader once columns are fetched
                    document.getElementById('loader').style.display = 'none';

                    if (fileInputId === "file1") {
                        populateDropdown("#wfmColumn", response.columns);
                    } else if (fileInputId === "file2") {
                        populateDropdown("#nonCommColumn", response.columns);
                        populateDropdown("#hesColumn", response.columns);
                    }
                },
                error: function (xhr) {
                    // Hide loader if error occurs
                    document.getElementById('loader').style.display = 'none';
                    alert("Error: " + xhr.responseJSON.error);
                }
            });
        }

        function populateDropdown(dropdownId, columns) {
            const dropdown = $(dropdownId);
            dropdown.empty();
            dropdown.append('<option value="" disabled selected>Select column</option>');
            columns.forEach(column => {
                dropdown.append(`<option value="${column}">${column}</option>`);
            });
        }

        $("#processButton").click(function () {
            // Show loader during data processing
            document.getElementById('loader').style.display = 'block';

            let formData = new FormData();
            formData.append("file1", $("#file1")[0].files[0]);
            formData.append("file2", $("#file2")[0].files[0]);
            formData.append("wfmColumn", $("#wfmColumn").val());
            formData.append("hesColumn", $("#hesColumn").val());
            formData.append("nonCommColumn", $("#nonCommColumn").val());

            $.ajax({
                url: "/process_data",
                type: "POST",
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    // Hide loader once data is processed
                    document.getElementById('loader').style.display = 'none';

                    // Display the processed data preview
                    showPreview(response);

                    // Display download links after previewing
                    $("#links").html(` 
                        
                        <a href="${response.nonCommFile}" download>Non-Comm Data</a><br>
                        <a href="${response.neverCommFile}" download> Never-Comm Data</a><br>
                        <a href="${response.unmappedFile}" download> Unmapped Data</a><br>
                    `);
                },
                error: function (xhr) {
                    // Hide loader on error
                    document.getElementById('loader').style.display = 'none';
                    alert("Error: " + xhr.responseJSON.error);
                }
            });
        });

        function showPreview(response) {
            // Show the preview section
            document.getElementById('preview').style.display = 'block';

            // Assuming the data is in a tabular format (e.g., JSON array of rows)
            const data = response.previewData;
            const table = $("#dataTable");

            // Clear previous data in the table
            table.empty();

            // Create table headers
            if (data && data.length > 0) {
                const headers = Object.keys(data[0]);
                const headerRow = $("<tr>");
                headers.forEach(header => {
                    headerRow.append(`<th>${header}</th>`);
                });
                table.append(headerRow);

                // Add table rows
                data.forEach(row => {
                    const rowElement = $("<tr>");
                    headers.forEach(header => {
                        rowElement.append(`<td>${row[header]}</td>`);
                    });
                    table.append(rowElement);
                });

                // Show the download button after preview
                $("#downloadButton").show();
            } else {
                table.append("<tr><td colspan='100%'>No data to display.</td></tr>");
            }
        }
        function updateSummary(summary) {
    const tbody = $("#summaryTable tbody");
    tbody.empty(); // Clear previous summary data

    // Populate the summary table with the provided data
    for (const [key, value] of Object.entries(summary)) {
        const row = `<tr>
            <td>${key}</td>
            <td>${value}</td>
        </tr>`;
        tbody.append(row);
    }

    // Show the summary section
    $("#summarySection").show();
}

$("#processButton").click(function () {
    // Show loader during data processing
    document.getElementById("loader").style.display = "block";

    let formData = new FormData();
    formData.append("file1", $("#file1")[0].files[0]);
    formData.append("file2", $("#file2")[0].files[0]);
    formData.append("wfmColumn", $("#wfmColumn").val());
    formData.append("hesColumn", $("#hesColumn").val());
    formData.append("nonCommColumn", $("#nonCommColumn").val());

    $.ajax({
        url: "/process_data",
        type: "POST",
        data: formData,
        contentType: false,
        processData: false,
        success: function (response) {
            // Hide loader once data is processed
            document.getElementById("loader").style.display = "none";

            // Display the processed data preview (optional)
            showPreview(response.previewData);

            // Update the summary section with response data
            updateSummary(response.summary);
        },
        error: function (xhr) {
            // Hide loader and show an error message
            document.getElementById("loader").style.display = "none";
            alert("An error occurred while processing the files. Please try again.");
        },
    });
});
    </script>
</body>
</html>
